<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
</head>
<body>
<canvas id="canvas" width="300" height="300" style="border: 1px solid"></canvas>
<input type="file" id="upload" accept="audio/*">
<button onclick="play()">Play</button>
<script src="../assets/lib/sgl.js"></script>
<script>

    let canvas = document.getElementById("canvas")
    let gl = canvas.getContext("webgl2")

    let vertexShaderSource = `#version 300 es
    in float x;
    in float y;
    out vec4 v_color;

    void main(){
      gl_Position = vec4(x, y*2.0-1.0, 0, 1);
      v_color = vec4(0.5, 0.5, 0.5, 1);
    }
    `

    let fragmentShaderSource = `#version 300 es
     precision highp float;

     in vec4 v_color;
     out vec4 OutColor;
     void main(){
      OutColor = v_color;
     }
    `

    let glProgram = initShader(gl, vertexShaderSource, fragmentShaderSource);


    let audioCtx = new window.AudioContext({
        latencyHint: 'interactive',
        sampleRate: 48000,
    });

    let options = {
        'fftSize': 2048,
        'maxDecibels': -30,
        'minDecibels': -100,
        'smoothingTimeConstant': 0.8
    }
    let analyser = new AnalyserNode(audioCtx, options)
    let binCount = analyser.frequencyBinCount;
    let x = new Float32Array(binCount)
    let y = new Uint8Array(binCount);
    for (let i = 0; i < 2 * binCount; i += 2) {
        x[i / 2] = i / binCount - 1;
    }
    console.log(x)
    console.log(binCount)
    setVertexAttribArray(gl, glProgram, x, gl.FLOAT, "x", 1, false)


    function play() {
        // The AudioContext was not allowed to start. It must be resumed (or created) after a user gesture on the page.
        audioCtx.resume()

        console.log(audioCtx, analyser)
        let audio = createAudio("https://objectstorage.ap-tokyo-1.oraclecloud.com/p/gUGXye66cen52xuqwZ5q-hgItpn_PZSu9gF5yC_ILs86k7NxBXRz6JCrsV8E5KlK/n/nrshlr1tpmbr/b/bucket-20210530-1145/o/%E3%80%90%E5%8E%9F%E7%A5%9E%E3%80%91%E7%A5%9E%E9%87%8C%E7%BB%AB%E5%8D%8E%E3%80%8C%E7%99%BD%E9%B9%AD%E5%BD%92%E5%BA%AD%E3%80%8D.flac", true);
        let source = audioCtx.createMediaElementSource(audio);

        source.connect(analyser);
        analyser.connect(audioCtx.destination);
        audio.play();

        render()
    }

    function createAudio(src, loop) {
        let audio = new Audio(src);
        audio.loop = loop || true;
        audio.crossOrigin = "anonymous";
        audio.load();
        return audio;
    }


    function render() {
        analyser.getByteFrequencyData(y)
        setVertexAttribArray(gl, glProgram, y, gl.UNSIGNED_BYTE, "y", 1, true, gl.DYNAMIC_DRAW)
        gl.drawArrays(gl.LINE_STRIP, 0, 1024)
        console.log(y.reduce((x, y, index) => {
            return x + y
        }))
        requestAnimationFrame(render)
    }


</script>
</body>
</html>